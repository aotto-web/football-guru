import streamlit as st
import pandas as pd
import numpy as np
from scipy.stats import poisson

# --- ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ---
st.set_page_config(page_title="PL Auto-Predictor", layout="wide")
st.title("‚öΩ Premier League Real-Time Predictor")
st.write("‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏Ç‡πà‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î")

# --- 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏î (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏Ñ‡πà‡∏≤‡∏û‡∏•‡∏±‡∏á‡∏ó‡∏µ‡∏°) ---
@st.cache_data(ttl=3600) # ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ß‡πâ 1 ‡∏ä‡∏°. ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡∏î‡∏∂‡∏á‡∏ö‡πà‡∏≠‡∏¢‡∏à‡∏ô‡πÇ‡∏î‡∏ô‡∏ö‡∏•‡πá‡∏≠‡∏Å
def get_live_stats():
    try:
        # ‡∏î‡∏∂‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏≤‡∏Å FBRef (‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ü‡∏∏‡∏ï‡∏ö‡∏≠‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Python)
        url = "https://www.worldfootball.net/premier_league_2025_2026/table/"
        tables = pd.read_html(url)
        df = tables[0]
        
        # ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        df = df[['#', 'Team', 'M.', 'Goals', 'Pts']]
        # ‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡πÑ‡∏î‡πâ-‡πÄ‡∏™‡∏µ‡∏¢‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏±‡∏ô (‡πÄ‡∏ä‡πà‡∏ô 45:20)
        df[['Scored', 'Conceded']] = df['Goals'].str.split(':', expand=True).astype(int)
        
        # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Ç‡∏≠‡∏á‡∏•‡∏µ‡∏Å
        avg_scored = df['Scored'].mean()
        avg_conceded = df['Conceded'].mean()
        
        # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Offense ‡πÅ‡∏•‡∏∞ Defense Strength ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ó‡∏µ‡∏°
        df['Offense'] = df['Scored'] / avg_scored
        df['Defense'] = df['Conceded'] / avg_conceded
        
        return df, avg_scored / 2, avg_conceded / 2 # ‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ó‡∏µ‡∏°
    except Exception as e:
        st.error(f"‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÑ‡∏î‡πâ: {e}")
        return None, 1.5, 1.3

# --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô (Fixtures) ---
@st.cache_data(ttl=3600)
def get_fixtures():
    try:
        # ‡∏î‡∏∂‡∏á‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô
        url = "https://www.worldfootball.net/schedule/eng-premier-league-2025-2026-spieltag/25/" # Spieltag ‡∏Ñ‡∏∑‡∏≠‡∏ô‡∏±‡∏î‡∏ó‡∏µ‡πà
        tables = pd.read_html(url)
        fixtures_df = tables[1] # ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏°‡∏±‡∏Å‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô index 1 ‡∏´‡∏£‡∏∑‡∏≠ 2
        return fixtures_df
    except:
        return None

# --- 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Poisson ---
def predict_match(home_team, away_team, stats_df, avg_h, avg_a):
    try:
        h_stat = stats_df[stats_df['Team'].str.contains(home_team)].iloc[0]
        a_stat = stats_df[stats_df['Team'].str.contains(away_team)].iloc[0]
        
        exp_h = h_stat['Offense'] * a_stat['Defense'] * avg_h
        exp_a = a_stat['Offense'] * h_stat['Defense'] * avg_a
        
        h_prob = [poisson.pmf(i, exp_h) for i in range(7)]
        a_prob = [poisson.pmf(i, exp_a) for i in range(7)]
        m = np.outer(h_prob, a_prob)
        
        ph = np.sum(np.tril(m, -1))
        pd = np.sum(np.diag(m))
        pa = np.sum(np.triu(m, 1))
        hp, ap = np.unravel_index(m.argmax(), m.shape)
        
        return exp_h, exp_a, ph, pd, pa, f"{hp}-{ap}"
    except:
        return 0, 0, 0, 0, 0, "N/A"

# --- ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏° ---
df_stats, avg_h, avg_a = get_live_stats()
fixtures = get_fixtures()

if df_stats is not None:
    st.sidebar.header("üìä ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô")
    st.sidebar.dataframe(df_stats[['Team', 'Pts', 'Offense', 'Defense']], hide_index=True)

    st.header("üìÖ ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡∏ô‡∏±‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ")
    
    # ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏π‡πà‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤‡πÑ‡∏î‡πâ
    for index, row in fixtures.iterrows():
        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡πá‡∏ö‡∏°‡∏±‡∏Å‡∏°‡∏µ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ß‡πà‡∏≤‡∏á)
        if isinstance(row[2], str) and ' - ' not in row[2]: 
            home = row[2]
            away = row[4]
            
            xh, xa, ph, pd, pa, score = predict_match(home, away, df_stats, avg_h, avg_a)
            
            with st.expander(f"üèüÔ∏è {home} vs {away}"):
                c1, c2, c3 = st.columns(3)
                c1.metric(f"{home} ‡∏ä‡∏ô‡∏∞", f"{ph*100:.1f}%")
                c2.metric("‡πÄ‡∏™‡∏°‡∏≠", f"{pd*100:.1f}%")
                c3.metric(f"{away} ‡∏ä‡∏ô‡∏∞", f"{pa*100:.1f}%")
                st.write(f"‡∏™‡∏Å‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î: **{score}** (xG: {xh:.2f} - {xa:.2f})")

else:
    st.warning("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå... ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠")

st.info("üí° ‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å worldfootball.net ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡∏ô‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ")
